name: Deploy backend to Fly.io

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FLY_APP_NAME: code-puppy-api

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies for linting
        run: |
          pip install -r backend/requirements.txt
          pip install -e .

      - name: Run unit tests (worker smoke)
        run: |
          python -m compileall src/code_puppy_gui

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Ensure Fly app exists
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if flyctl apps show "$FLY_APP_NAME" >/dev/null 2>&1; then
            echo "Fly app $FLY_APP_NAME already exists."
          else
            echo "Creating Fly app $FLY_APP_NAME..."
            flyctl apps create "$FLY_APP_NAME"
          fi

      - name: Configure secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          SYN_API_KEY: ${{ secrets.SYN_API_KEY }}
        run: |
          if [ -z "$SYN_API_KEY" ]; then
            echo "SYN_API_KEY is empty. Skipping flyctl secrets set."
            exit 0
          fi

          if flyctl secrets set SYN_API_KEY="$SYN_API_KEY" --app "$FLY_APP_NAME" --detach; then
            echo "SYN_API_KEY synced to $FLY_APP_NAME."
          else
            echo "flyctl couldn't find $FLY_APP_NAME yet. Attempting to create it now..."
            if flyctl apps create "$FLY_APP_NAME"; then
              flyctl secrets set SYN_API_KEY="$SYN_API_KEY" --app "$FLY_APP_NAME" --detach
            else
              echo "::error::Unable to create Fly app $FLY_APP_NAME. Update fly.toml (app value) to a unique name or create the app manually, then rerun."
              exit 1
            fi
          fi

      - name: Deploy via Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --config fly.toml --remote-only
